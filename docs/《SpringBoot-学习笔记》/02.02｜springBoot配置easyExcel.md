---
title: 02ï½œspringBooté…ç½®easyExcel
date: 2022-01-19 10:11:37
permalink: /pages/515da4/
categories:
  - ã€ŠSpringBoot-å­¦ä¹ ç¬”è®°ã€‹
tags:
  - SpringBoot
  - easyExcel
---
## ç®€å•ä½¿ç”¨æµ‹è¯•

`pom.xml`æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>easyexcel</artifactId>
    <version>3.0.5</version>
</dependency>
```
å¯¹äºç®€å•çš„å¯¼å…¥å¯¼å‡ºå°è£…äº†ä¸€ä¸ª`XlxsTool`å·¥å…·ç±»

```java
package com.wg.easyexcel;
import com.alibaba.excel.EasyExcel;
import com.alibaba.excel.ExcelWriter;
import com.alibaba.excel.context.AnalysisContext;
import com.alibaba.excel.event.AnalysisEventListener;
import com.alibaba.excel.read.metadata.holder.ReadSheetHolder;
import com.alibaba.excel.write.metadata.WriteSheet;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.FileInputStream;
import java.io.InputStream;
import java.util.*;
import java.util.concurrent.atomic.AtomicInteger;



public class XlxsTool {

    private static final Logger log = LoggerFactory.getLogger(XlxsTool.class);
    
    public static <T> List<T> loadExcel(String excelPath, Class<T> clazz) {
        try (FileInputStream fis = new FileInputStream(excelPath)) {
            return loadExcel(fis, clazz);
        } catch (Exception xe) {
            throw new RuntimeException(xe);
        }
    }

    public static <T> List<T> loadExcel(InputStream inputStream, Class<T> clazz) {
        ExcelDataListener<T> excelDataListener = new ExcelDataListener<>();
        EasyExcel.read(inputStream, clazz, excelDataListener).sheet().doRead();
        return excelDataListener.getResult();
    }

    public static <T> Map<String, List<T>> loadAllExcel(String excelPath, Class<T> clazz) {
        try (FileInputStream fis = new FileInputStream(excelPath)) {
            return loadAllExcel(fis, clazz);
        } catch (Exception xe) {
            throw new RuntimeException(xe);
        }
    }

    public static <T> Map<String, List<T>> loadAllExcel(InputStream inputStream, Class<T> clazz) {
        ExcelDataAllSheetListener<T> excelDataListener = new ExcelDataAllSheetListener<>();
        EasyExcel.read(inputStream, clazz, excelDataListener).doReadAll();
        return excelDataListener.getResult();
    }

    public static <T> void export(String filePath, Class<T> type, List<T> mainExcelData) {
        EasyExcel.write(filePath, type).sheet().doWrite(mainExcelData);
    }

    public static <T> void export(String filePath, Class<T> type, Map<String, List<T>> mainExcelData) {
        ExcelWriter excelWriter = EasyExcel.write(filePath, type).build();
        AtomicInteger i = new AtomicInteger();
        mainExcelData.forEach((key, value) -> {
            WriteSheet writeSheet = EasyExcel.writerSheet(i.getAndIncrement(), key).build();
            excelWriter.write(value, writeSheet);
        });
        excelWriter.finish();
    }

    public static class ExcelDataListener<T> extends AnalysisEventListener<T> {
        private final List<T> result = new ArrayList<>();

        @Override
        public void invoke(T data, AnalysisContext context) {
            result.add(data);
        }

        @Override
        public void doAfterAllAnalysed(AnalysisContext context) {

        }

        public List<T> getResult() {
            return result;
        }
    }

    public static class ExcelDataAllSheetListener<T> extends AnalysisEventListener<T> {
        private final Map<String, List<T>> result = new LinkedHashMap<>();

        @Override
        public void invoke(T data, AnalysisContext context) {
            ReadSheetHolder readSheetHolder = context.readSheetHolder();
            String sheetName = readSheetHolder.getSheetName();
            List<T> ts = result.computeIfAbsent(sheetName, k -> new ArrayList<>());
            ts.add(data);
        }

        @Override
        public void doAfterAllAnalysed(AnalysisContext context) {

        }

        public Map<String, List<T>> getResult() {
            return result;
        }
    }

}
```
åˆ›å»ºå®ä½“ç±»
```java
package com.wg.easyexcel.entity;

import com.alibaba.excel.annotation.ExcelIgnore;
import com.alibaba.excel.annotation.ExcelProperty;
import com.alibaba.excel.annotation.format.DateTimeFormat;
import com.alibaba.excel.annotation.write.style.ColumnWidth;
import com.wg.easyexcel.util.DefineConverter;
import lombok.Data;
import lombok.EqualsAndHashCode;

import java.util.Date;

@Data
@EqualsAndHashCode(callSuper = false)
public class Member {
        @ExcelProperty(value = "ID", index = 0)
        @ColumnWidth(10)
        private Long id;

        @ExcelProperty(value = "ç”¨æˆ·å", index = 1)
        @ColumnWidth(20)
        private String username;

        @ExcelIgnore
        private String password;

        @ExcelProperty(value = "æ˜µç§°", index = 2)
        @ColumnWidth(20)
        private String nickname;

        @ExcelProperty(value = "å‡ºç”Ÿæ—¥æœŸ", index = 3)
        @ColumnWidth(20)
        @DateTimeFormat("yyyy-MM-dd")
        private Date birthday;

        @ExcelProperty(value = "æ‰‹æœºå·", index = 4)
        @ColumnWidth(20)
        private String phone;

        @ExcelIgnore
        private String icon;

        @ExcelProperty(value = "æ€§åˆ«", index = 5, converter = DefineConverter.GenderConverter.class)
        @ColumnWidth(10)
        private Integer gender;
}
```
ç±»æ³¨è§£

[@Dataä¸@EqualsAndHashCodeçš„ä½¿ç”¨](https://www.yuque.com/weig/backend/xizdxu?view=doc_embed)

ç”¨åˆ°çš„easyexcelä¸­çš„æ³¨è§£ï¼Œä¸€èˆ¬å¸¸ç”¨çš„ä¹Ÿå°±ä¸‹é¢è¿™å‡ ä¸ª

- `@ExcelProperty(value = "ID", index = 0) `ï¼šindexä¸ºexcelä¸­åˆ—çš„ç´¢å¼•é¡ºåº
- `@ColumnWidth(10)`ï¼šåˆ—çš„å®½åº¦
- `@DateTimeFormat("yyyy-MM-dd")`ï¼šæ—¶é—´æ ¼å¼
- `@ExcelIgnore`ï¼šå¿½ç•¥é¡¹

> å…¶ä»–æ³¨è§£å‚è€ƒ
> [https://www.cnblogs.com/bluekang/p/13438666.html](https://www.cnblogs.com/bluekang/p/13438666.html)


:::tip
@ExcelProperty æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ³¨è§£ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°value,index,converterã€‚åˆ†åˆ«ä»£è¡¨åˆ—åï¼Œåˆ—åºå·ï¼Œæ•°æ®è½¬æ¢æ–¹å¼
valueå’Œindexåªèƒ½äºŒé€‰ä¸€ï¼Œé€šå¸¸ä¸ç”¨è®¾ç½®converter
1. value ï¼šé€šè¿‡æ ‡é¢˜æ–‡æœ¬å¯¹åº”
2. index ï¼šé€šè¿‡æ–‡æœ¬è¡Œå·å¯¹åº”
3. converter ï¼šé€šå¸¸å…¥åº“å’Œå‡ºåº“è½¬æ¢ä½¿ç”¨ï¼Œå¦‚æ€§åˆ«ï¼Œå…¥åº“0å’Œ1ï¼Œå‡ºåº“ç”·å’Œå¥³
:::


åˆ›å»ºè‡ªå®šä¹‰è½¬æ¢å™¨

```java
package com.wg.easyexcel.util;

import com.alibaba.excel.converters.Converter;
import com.alibaba.excel.converters.ReadConverterContext;
import com.alibaba.excel.converters.WriteConverterContext;
import com.alibaba.excel.enums.CellDataTypeEnum;
import com.alibaba.excel.metadata.data.WriteCellData;
import com.alibaba.excel.util.StringUtils;

/**
 * è‡ªå®šä¹‰è½¬æ¢å™¨
 */
public class DefineConverter {

     // excelæ€§åˆ«è½¬æ¢å™¨
     // Stringä¸Integerè½¬æ¢
    public static class GenderConverter implements Converter<Integer> {
        @Override
        public Class<?> supportJavaTypeKey() {
            // å¯¹è±¡ç±»å‹å±æ€§
            return Integer.class;
        }

        @Override
        public CellDataTypeEnum supportExcelTypeKey() {
            // CellDataå±æ€§ç±»å‹
            return CellDataTypeEnum.STRING;
        }

        @Override
        public Integer convertToJavaData(ReadConverterContext<?> context) throws Exception {
            // CellDataè½¬å¯¹è±¡å±æ€§
            String cellStr = context.getReadCellData().getStringValue();
            if (StringUtils.isEmpty(cellStr)){
                return null;
            }
            if ("ç”·".equals(cellStr)){
                return 0;
            }else if ("å¥³".equals(cellStr)){
                return 1;
            }else {
                return null;
            }
        }

        @Override
        public WriteCellData<?> convertToExcelData(WriteConverterContext<Integer> context) throws Exception {
            // å¯¹è±¡å±æ€§è½¬CellData
            Integer cellValue = context.getValue();
            if (cellValue == null){
                return new WriteCellData<>("");
            }
            if (cellValue == 0){
                return new WriteCellData<>("ç”·");
            }else if (cellValue == 1) {
                return new WriteCellData<>("å¥³");
            } else {
                return new WriteCellData<>("");
            }
        }
    }
}
```
åœ¨`pom.xml`ä¸­æ·»åŠ `juint`çš„ä¾èµ–ï¼Œä½¿ç”¨`junit`æµ‹è¯•
```java
package com.wg.easyexcel;
import com.wg.easyexcel.entity.Member;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.*;

// ç®€å•å¯¼å…¥å¯¼å‡º
public class simpleDemo {

    private static final Logger log = LoggerFactory.getLogger(simpleDemo.class);
    private static final String readExcelPath = "/Users/weigang/IdeaProjects/study/easyexcel/src/main/resources/file/simple/simple-excel.xlsx";
    private static final String outputExcelPath = "/Users/weigang/IdeaProjects/study/easyexcel/src/main/resources/file/simple/simple-excel-output.xlsx";

    @Test
    public void test(){
        // å• sheet è¯»å–
        List<Member> dataList = XlxsTool.loadExcel(readExcelPath, Member.class);
        
        // å¤šsheet è¯»å–
        // keyä¸ºsheeté¡µçš„åå­—ï¼Œvalueä¸ºå¯¹åº”sheeté¡µçš„æ•°æ®
        // Map<String ,List<Member>> dataMap = XlxsTool.loadAllExcel(readExcelPath, Member.class);
        
        // å¯¼å‡º
        XlxsTool.export(outputExcelPath, Member.class, dataList);
    }
}
```
æ•ˆæœ

![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642419170121-2e0acbcd-eb23-47c7-a03e-e378fe8b4058.png)



## å®ä¾‹ï¼šmybatis+mysql+easyexcel

### æ¡ˆä¾‹ä¸€ï¼šç®€å•å¯¼å…¥å¯¼å‡ºMemberè¡¨

Mysqlæ•°æ®åº“

memberå»ºè¡¨è¯­å¥

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for member
-- ----------------------------
DROP TABLE IF EXISTS `member`;
CREATE TABLE `member` (
  `id` bigint NOT NULL,
  `username` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `nickname` varchar(255) DEFAULT NULL,
  `birthday` varchar(255) DEFAULT NULL,
  `phone` varchar(255) DEFAULT NULL,
  `gender` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of member
-- ----------------------------
BEGIN;
INSERT INTO `member` VALUES (1, 'weig', '1234', 'gangzi', '1995-05-27', '15900330611', 0);
INSERT INTO `member` VALUES (2, 'lijr', '1234', 'ruru', '1995-07-01', '13920803165', 1);
INSERT INTO `member` VALUES (3, 'weip', '1234', 'erdan', '1997-04-25', '15900330611', 0);
COMMIT;

SET FOREIGN_KEY_CHECKS = 1;

```
å®šä¹‰å¯¹åº”å®ä½“ç±» Member
```java
@Data
@EqualsAndHashCode(callSuper = false)
public class Member {
        @ExcelProperty(value = "ID", index = 0)
        @ColumnWidth(10)
        private Long id;

        @ExcelProperty(value = "ç”¨æˆ·å", index = 1)
        @ColumnWidth(20)
        private String username;

        @ExcelIgnore
        private String password;

        @ExcelProperty(value = "æ˜µç§°", index = 2)
        @ColumnWidth(20)
        private String nickname;

        @ExcelProperty(value = "å‡ºç”Ÿæ—¥æœŸ", index = 3)
        @ColumnWidth(20)
        @DateTimeFormat("yyyy-MM-dd")
        private Date birthday;

        @ExcelProperty(value = "æ‰‹æœºå·", index = 4)
        @ColumnWidth(20)
        private String phone;

        @ExcelIgnore
        private String icon;

        @ExcelProperty(value = "æ€§åˆ«", index = 5, converter = DefineConverter.GenderConverter.class)
        @ColumnWidth(10)
        private Integer gender;
}

```
è¿˜æ˜¯éœ€è¦å®šä¹‰è½¬æ¢å™¨ï¼Œé‡‡ç”¨å¦‚ä¸Šå°±å¯ä»¥

å®šä¹‰å¯¹åº”Mapperæ¥å£ MemberMapper

```java
@Mapper
public interface MemberMapper {

    @Select("SELECT * FROM member")
    @Results({
            @Result(property = "id", column = "id"),
            @Result(property = "username", column = "username"),
            @Result(property = "password", column = "password"),
            @Result(property = "nickname", column = "nickname"),
            @Result(property = "birthday", column = "birthday"),
            @Result(property = "phone", column = "phone"),
            @Result(property = "gender", column = "gender"),
    })
    List<Member> getMember();
}

```
å®šä¹‰å¯¹åº”serviceå±‚ MemberServiceImpl
```java
@Service
public class MemberServiceImpl {
    @Autowired
    MemberMapper mapper;

    public List<Member> getMember(){
        return mapper.getMember();
    }
}
```
å®šä¹‰controllerå±‚ easyexcelController
```java
@RestController
@RequestMapping("/easyexcel")
public class easyexcelController {
    @Autowired
    MemberMapper memberService;

    // ç®€å•å¯¼å…¥
    @SneakyThrows
    @RequestMapping(value = "/importMemberList", method = RequestMethod.POST)
    @ResponseBody
    public CommonResult importMemberList(@RequestPart("file") MultipartFile file) {
        List<Member> memberList = EasyExcel.read(file.getInputStream())
                .head(Member.class)
                .sheet()
                .doReadSync();
        return CommonResult.success(memberList);
    }


    // è®¾ç½®excelä¸‹è½½å“åº”å¤´å±æ€§
    private void setExcelRespProp(HttpServletResponse response, String rawFileName) throws UnsupportedEncodingException {
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode(rawFileName, "UTF-8").replaceAll("\\+" ,"%20");
        response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");
    }

    // ç®€å•å¯¼å‡º
    @SneakyThrows(IOException.class)
    @RequestMapping(value = "/exportMemberList", method = RequestMethod.GET)
    public void exportMemberList(HttpServletResponse response) {
        setExcelRespProp(response, "ä¼šå‘˜åˆ—è¡¨");
        List<Member> memberList = memberService.getMember();
        EasyExcel.write(response.getOutputStream())
                .head(Member.class)
                .excelType(ExcelTypeEnum.XLSX)
                .sheet("ä¼šå‘˜åˆ—è¡¨")
                .doWrite(memberList);
    }
}

```
**è¡¥å……ï¼š**

å¯¹äºå¯¼å…¥è¿”å›çš„ç»“æœè·å–ï¼Œå°è£…äº†ä¸€ä¸ªé€šç”¨å¯¹è±¡CommonResult

é¦–å…ˆåˆ›å»ºä¸€ä¸ªå°è£…APIçš„é”™è¯¯ç çš„æ¥å£IErrorCode

```java
/**
 * å°è£…APIçš„é”™è¯¯ç 
 * Created by macro on 2019/4/19.
 */
public interface IErrorCode {
    long getCode();
    String getMessage();
}
```
å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ResultCodeç”¨æ¥è¿”å›ä¸€äº›é”™è¯¯ç 
```java
package com.wg.easyexcel.common.api;

public enum ResultCode implements IErrorCode{
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    FAILED(500, "æ“ä½œå¤±è´¥"),
    VALIDATE_FAILED(404, "å‚æ•°æ£€éªŒå¤±è´¥"),
    UNAUTHORIZED(401, "æš‚æœªç™»å½•æˆ–tokenå·²ç»è¿‡æœŸ"),
    FORBIDDEN(403, "æ²¡æœ‰ç›¸å…³æƒé™");
    private long code;
    private String message;

    private ResultCode(long code, String message) {
        this.code = code;
        this.message = message;
    }

    public long getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}

```
é€šè¿‡æ³›å‹å®šä¹‰ä¸€ä¸ªé€šç”¨è¿”å›å¯¹è±¡ CommonResult
```java
package com.wg.easyexcel.common.api;

import org.apache.poi.ss.formula.functions.T;

/**
 * é€šç”¨è¿”å›å¯¹è±¡
 * Created by macro on 2019/4/19.
 */
public class CommonResult<T> {

    private long code;
    private String message;
    private T data;

    protected CommonResult() {
    }

    protected CommonResult(long code, String message, T data) {
        this.code = code;
        this.message = message;
        this.data = data;
    }

    /**
     * æˆåŠŸè¿”å›ç»“æœ
     *
     * @param data è·å–çš„æ•°æ®
     */
    public static <T> CommonResult<T> success(T data) {
        return new CommonResult<T>(ResultCode.SUCCESS.getCode(), ResultCode.SUCCESS.getMessage(), data);
    }

    /**
     * æˆåŠŸè¿”å›ç»“æœ
     *
     * @param data è·å–çš„æ•°æ®
     * @param  message æç¤ºä¿¡æ¯
     */
    public static <T> CommonResult<T> success(T data, String message) {
        return new CommonResult<T>(ResultCode.SUCCESS.getCode(), message, data);
    }

    /**
     * å¤±è´¥è¿”å›ç»“æœ
     * @param errorCode é”™è¯¯ç 
     */
    public static <T> CommonResult<T> failed(IErrorCode errorCode) {
        return new CommonResult<T>(errorCode.getCode(), errorCode.getMessage(), null);
    }

    /**
     * å¤±è´¥è¿”å›ç»“æœ
     * @param message æç¤ºä¿¡æ¯
     */
    public static <T> CommonResult<T> failed(String message) {
        return new CommonResult<T>(ResultCode.FAILED.getCode(), message, null);
    }

    /**
     * å¤±è´¥è¿”å›ç»“æœ
     */
    public static <T> CommonResult<T> failed() {
        return failed(ResultCode.FAILED);
    }

    /**
     * å‚æ•°éªŒè¯å¤±è´¥è¿”å›ç»“æœ
     */
    public static <T> CommonResult<T> validateFailed() {
        return failed(ResultCode.VALIDATE_FAILED);
    }

    /**
     * å‚æ•°éªŒè¯å¤±è´¥è¿”å›ç»“æœ
     * @param message æç¤ºä¿¡æ¯
     */
    public static <T> CommonResult<T> validateFailed(String message) {
        return new CommonResult<T>(ResultCode.VALIDATE_FAILED.getCode(), message, null);
    }

    /**
     * æœªç™»å½•è¿”å›ç»“æœ
     */
    public static <T> CommonResult<T> unauthorized(T data) {
        return new CommonResult<T>(ResultCode.UNAUTHORIZED.getCode(), ResultCode.UNAUTHORIZED.getMessage(), data);
    }

    /**
     * æœªæˆæƒè¿”å›ç»“æœ
     */
    public static <T> CommonResult<T> forbidden(T data) {
        return new CommonResult<T>(ResultCode.FORBIDDEN.getCode(), ResultCode.FORBIDDEN.getMessage(), data);
    }

    public long getCode() {
        return code;
    }

    public void setCode(long code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public T getData() {
        return data;
    }

    public void setData(T data) {
        this.data = data;
    }
}

```


é€šè¿‡ApiPostæ¥å£æµ‹è¯•

åœ¨å¯¼å…¥æ—¶ï¼Œè®¾ç½®ä¸ºPostè¯·æ±‚ã€‚æµ‹è¯•æ—¶éœ€æ³¨æ„ï¼ŒåŒæ—¶éœ€è¦åœ¨å¦‚å›¾ä½ç½®ï¼Œè®¾ç½®ä¸Šä¼ å‚æ•°ï¼Œé€‰æ‹©ä¸Šä¼ çš„æ–‡ä»¶

å®æ—¶å“åº”ä¸ºè§£æå‡ºçš„excelå†…å®¹
![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642468478568-36b655af-1345-4e71-9d4b-5ac460ccfefc.png)

åœ¨å¯¼å‡ºè®¾ç½®ä¸ºGetè¯·æ±‚ï¼Œåœ¨æµ‹è¯•æ—¶éœ€æ³¨æ„ï¼Œæµ‹è¯•æˆåŠŸåï¼Œç‚¹å‡»å³ä¸‹æ–¹çš„ä¸‹è½½ï¼ŒæŸ¥çœ‹è¾“å‡ºexcelå†…å®¹

![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642468318993-e1e70b5f-1a44-4fc0-9eda-0dc1a645d6e7.png)

![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642469574147-ffbfc424-6472-4660-9173-cb1e82ca13dd.png)


### æ¡ˆä¾‹äºŒï¼šå¤æ‚å¯¼å‡ºorderï¼Œå®ç°è‡ªå®šä¹‰å•å…ƒæ ¼åˆå¹¶
**ä¸šåŠ¡ï¼š**

ä¸€ä¸ªè®¢å• orderï¼Œä¸€ä¸ªé¡¾å®¢ memberï¼Œä¸€ä¸ªå•†å“ product

æ¯ä¸ªè®¢å• order æœ‰

1. è®¢å•æœ¬èº«ä¿¡æ¯
1. å¯¹åº”çš„é¡¾å®¢ member
1. å¯¹åº”çš„è‹¥å¹²å•†å“ List<product>



order

è®¢å•IDï¼Œè®¢å•ç¼–å·ï¼Œåˆ›å»ºæ—¶é—´ï¼Œæ”¶è´§åœ°å€ï¼Œmemberï¼ŒList<product>



**æ•ˆæœ**

æ™®é€šè®¢å•è¡¨

![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642469902074-5a458e90-1112-4d0a-9458-2d4aff421e64.png)

å®ç°è‡ªå®šä¹‰åˆå¹¶å•å…ƒæ ¼ç­–ç•¥çš„è®¢å•è¡¨

![image.png](https://gitee.com/isgangzi/image-store/raw/master/img/1642470053641-2d820179-9b11-4cca-836f-2531c3c5b2b8.png)
â€‹

sqlæ–‡ä»¶

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for member
-- ----------------------------
DROP TABLE IF EXISTS `member`;
CREATE TABLE `member` (
  `id` bigint NOT NULL,
  `username` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `nickname` varchar(255) DEFAULT NULL,
  `birthday` varchar(255) DEFAULT NULL,
  `phone` varchar(255) DEFAULT NULL,
  `gender` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of member
-- ----------------------------
BEGIN;
INSERT INTO `member` VALUES (1, 'weig', '1234', 'gangzi', '1995-05-27', '15900330611', 0);
INSERT INTO `member` VALUES (2, 'lijr', '1234', 'ruru', '1995-07-01', '13920803165', 1);
INSERT INTO `member` VALUES (3, 'weip', '1234', 'erdan', '1997-04-25', '15900330611', 0);
COMMIT;

-- ----------------------------
-- Table structure for order
-- ----------------------------
DROP TABLE IF EXISTS `order`;
CREATE TABLE `order` (
  `id` bigint NOT NULL,
  `orderSn` varchar(255) DEFAULT NULL,
  `createTime` date DEFAULT NULL,
  `receiverAddress` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of order
-- ----------------------------
BEGIN;
INSERT INTO `order` VALUES (1, '20220115010100001', '2022-01-15', 'å¤©æ´¥å¸‚åŒ—è¾°åŒº');
INSERT INTO `order` VALUES (2, '20220115010100002', '2022-01-16', 'å¤©æ´¥å¸‚å’Œå¹³åŒº');
INSERT INTO `order` VALUES (3, '20220115010100003', '2022-01-17', 'å¤©æ´¥å¸‚è¥¿é’åŒº');
COMMIT;

-- ----------------------------
-- Table structure for product
-- ----------------------------
DROP TABLE IF EXISTS `product`;
CREATE TABLE `product` (
  `id` bigint NOT NULL,
  `productSn` varchar(255) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `subTitle` varchar(255) DEFAULT NULL,
  `brandName` varchar(255) DEFAULT NULL,
  `price` decimal(10,2) DEFAULT NULL,
  `count` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of product
-- ----------------------------
BEGIN;
INSERT INTO `product` VALUES (1, '7437788', 'å°ç±³10s', 'å°ç±³10sçš„æ ‡é¢˜', 'å°ç±³', 1.00, 100);
INSERT INTO `product` VALUES (2, '7437789', 'çº¢ç±³', 'çº¢ç±³çš„æ ‡é¢˜', 'å°ç±³', 2.00, 200);
INSERT INTO `product` VALUES (3, '7437799', 'Appale12', 'Appale12çš„æ ‡é¢˜', 'è‹¹æœ', 3.00, 300);
COMMIT;

SET FOREIGN_KEY_CHECKS = 1;

```
åœ¨å¦‚ä¸Šé¡¹ç›®è¿›è¡Œæ”¹è¿›ï¼ˆMemberä¹‹å‰å®šä¹‰è¿‡äº†ï¼Œåé¢ä¸å†ä»‹ç»ï¼‰

å®šä¹‰å¯¹åº”çš„å®ä½“ç±» Memberï¼ŒOrderï¼ŒProduct

```java
@Data
@EqualsAndHashCode(callSuper = false)
public class Order {
    private Long id;
    private String orderSn;
    private Date createTime;
    private String receiverAddress;
    private Member member;
    private List<Product> productList;
}

@Data
@EqualsAndHashCode(callSuper = false)
public class Product {
    private Long id;
    private String productSn;
    private String name;
    private String subTitle;
    private String brandName;
    private BigDecimal price;
    private Integer count;
}
```
å¯¹äºè‡ªå®šä¹‰å•å…ƒæ ¼åˆå¹¶ç­–ç•¥ï¼Œéœ€è¦å°†orderè¡¨çš„æ•°æ®å…ˆå¹³é“ºï¼Œé€šè¿‡å¦ä¸€å®ä½“ç±»OrderDataæ¥æ”¶
```java
@Data
@EqualsAndHashCode(callSuper = false)
public class OrderData {
        @ExcelProperty(value = "è®¢å•ID")
        @ColumnWidth(10)
        @CustomMerge(needMerge = true, isPk = true)
        private String id;

        @ExcelProperty(value = "è®¢å•ç¼–ç ")
        @ColumnWidth(20)
        @CustomMerge(needMerge = true)
        private String orderSn;

        @ExcelProperty(value = "åˆ›å»ºæ—¶é—´")
        @ColumnWidth(20)
        @DateTimeFormat("yyyy-MM-dd")
        @CustomMerge(needMerge = true)
        private Date createTime;

        @ExcelProperty(value = "æ”¶è´§åœ°å€")
        @CustomMerge(needMerge = true)
        @ColumnWidth(20)
        private String receiverAddress;

        
        @ExcelProperty(value = "é¡¾å®¢ç”¨æˆ·å")
        @ColumnWidth(20)
        @CustomMerge(needMerge = true)
        private String username;

        @ExcelProperty(value = "é¡¾å®¢æ˜µç§°")
        @ColumnWidth(30)
        @CustomMerge(needMerge = true)
        private String nickname;

   		// å¦‚æœä¸ºäºŒçº§è¡¨å¤´ï¼Œvalueè®¾ç½®ä¸ºæ•°ç»„å½¢å¼
        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å•†å“ç¼–ç "})
        @ColumnWidth(20)
        private String productSn;

        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å•†å“åç§°"})
        @ColumnWidth(20)
        private String name;

        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å•†å“æ ‡é¢˜"})
        @ColumnWidth(30)
        private String subTitle;

        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å“ç‰Œåç§°"})
        @ColumnWidth(20)
        private String brandName;

        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å•†å“ä»·æ ¼"})
        @ColumnWidth(20)
        private BigDecimal price;

        @ExcelProperty(value = {"å•†å“ä¿¡æ¯", "å•†å“æ•°é‡"})
        @ColumnWidth(20)
        private Integer count;
}

```
å…¶ä¸­å¯¹äºéƒ¨åˆ†éœ€è¦åˆå¹¶çš„å•å…ƒæ ¼ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªæ³¨è§£@CustomMergeæ¥æ ‡è¯†æ˜¯å¦éœ€è¦åˆå¹¶ä»¥åŠåˆå¹¶çš„ä¸»é”®
```java
/**
 * è‡ªå®šä¹‰æ³¨è§£ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶ä»¥åŠåˆå¹¶çš„ä¸»é”®
 */
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
public @interface CustomMerge {

    /**
     * æ˜¯å¦éœ€è¦åˆå¹¶å•å…ƒæ ¼
     */
    boolean needMerge() default false;

    /**
     * æ˜¯å¦æ˜¯ä¸»é”®,å³è¯¥å­—æ®µç›¸åŒçš„è¡Œåˆå¹¶
     */
    boolean isPk() default false;
}

```
æ¥ä¸‹æ¥çš„é‡å¤´æˆï¼Œå°±æ˜¯è‡ªå®šä¹‰å•å…ƒæ ¼çš„åˆå¹¶ç­–ç•¥ CustomMergeStrategyï¼Œæœ€ååœ¨å¯¼å‡ºæ¥å£ä¸Šéœ€è¦å°†å…¶æ³¨å†Œä¸Šå»
```java
/**
 * è‡ªå®šä¹‰å•å…ƒæ ¼åˆå¹¶ç­–ç•¥
 */
public class CustomMergeStrategy implements RowWriteHandler {

    /**
     * ä¸»é”®ä¸‹æ ‡
     */
    private Integer pkIndex;

    /**
     * éœ€è¦åˆå¹¶çš„åˆ—çš„ä¸‹æ ‡é›†åˆ
     */
    private List<Integer> needMergeColumnIndex = new ArrayList<>();

    /**
     * DTOæ•°æ®ç±»å‹
     */
    private Class<?> elementType;

    public CustomMergeStrategy(Class<?> elementType) {
        this.elementType = elementType;
    }

    @Override
    public void afterRowDispose(WriteSheetHolder writeSheetHolder, WriteTableHolder writeTableHolder, Row row, Integer relativeRowIndex, Boolean isHead) {
        // å¦‚æœæ˜¯æ ‡é¢˜,åˆ™ç›´æ¥è¿”å›
        if (isHead) {
            return;
        }

        // è·å–å½“å‰sheet
        Sheet sheet = writeSheetHolder.getSheet();

        // è·å–æ ‡é¢˜è¡Œ
        Row titleRow = sheet.getRow(0);

        if (null == pkIndex) {
            this.lazyInit(writeSheetHolder);
        }

        // åˆ¤æ–­æ˜¯å¦éœ€è¦å’Œä¸Šä¸€è¡Œè¿›è¡Œåˆå¹¶
        // ä¸èƒ½å’Œæ ‡é¢˜åˆå¹¶ï¼Œåªèƒ½æ•°æ®è¡Œä¹‹é—´åˆå¹¶
        if (row.getRowNum() <= 1) {
            return;
        }
        // è·å–ä¸Šä¸€è¡Œæ•°æ®
        Row lastRow = sheet.getRow(row.getRowNum() - 1);
        // å°†æœ¬è¡Œå’Œä¸Šä¸€è¡Œæ˜¯åŒä¸€ç±»å‹çš„æ•°æ®(é€šè¿‡ä¸»é”®å­—æ®µè¿›è¡Œåˆ¤æ–­)ï¼Œåˆ™éœ€è¦åˆå¹¶
        if (lastRow.getCell(pkIndex).getStringCellValue().equalsIgnoreCase(row.getCell(pkIndex).getStringCellValue())) {
            for (Integer needMerIndex : needMergeColumnIndex) {
                CellRangeAddress cellRangeAddress = new CellRangeAddress(row.getRowNum() - 1, row.getRowNum(),
                        needMerIndex, needMerIndex);
                sheet.addMergedRegionUnsafe(cellRangeAddress);
            }
        }
    }

    /**
     * åˆå§‹åŒ–ä¸»é”®ä¸‹æ ‡å’Œéœ€è¦åˆå¹¶å­—æ®µçš„ä¸‹æ ‡
     */
    private void lazyInit(WriteSheetHolder writeSheetHolder) {

        // è·å–å½“å‰sheet
        Sheet sheet = writeSheetHolder.getSheet();

        // è·å–æ ‡é¢˜è¡Œ
        Row titleRow = sheet.getRow(0);
        // è·å–DTOçš„ç±»å‹
        Class<?> eleType = this.elementType;

        // è·å–DTOæ‰€æœ‰çš„å±æ€§
        Field[] fields = eleType.getDeclaredFields();

        // éå†æ‰€æœ‰çš„å­—æ®µï¼Œå› ä¸ºæ˜¯åŸºäºDTOçš„å­—æ®µæ¥æ„å»ºexcelï¼Œæ‰€ä»¥å­—æ®µæ•° >= excelçš„åˆ—æ•°
        for (Field theField : fields) {
            // è·å–@ExcelPropertyæ³¨è§£ï¼Œç”¨äºè·å–è¯¥å­—æ®µå¯¹åº”åœ¨excelä¸­çš„åˆ—çš„ä¸‹æ ‡
            ExcelProperty easyExcelAnno = theField.getAnnotation(ExcelProperty.class);
            // ä¸ºç©º,åˆ™è¡¨ç¤ºè¯¥å­—æ®µä¸éœ€è¦å¯¼å…¥åˆ°excel,ç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ªå­—æ®µ
            if (null == easyExcelAnno) {
                continue;
            }
            // è·å–è‡ªå®šä¹‰çš„æ³¨è§£ï¼Œç”¨äºåˆå¹¶å•å…ƒæ ¼
            CustomMerge customMerge = theField.getAnnotation(CustomMerge.class);

            // æ²¡æœ‰@CustomMergeæ³¨è§£çš„é»˜è®¤ä¸åˆå¹¶
            if (null == customMerge) {
                continue;
            }

            for (int index = 0; index < fields.length; index++) {
                Cell theCell = titleRow.getCell(index);
                // å½“é…ç½®ä¸ºä¸éœ€è¦å¯¼å‡ºæ—¶ï¼Œè¿”å›çš„ä¸ºnullï¼Œè¿™é‡Œä½œä¸€ä¸‹åˆ¤æ–­ï¼Œé˜²æ­¢NPE
                if (null == theCell) {
                    continue;
                }
                // å°†å­—æ®µå’Œexcelçš„è¡¨å¤´åŒ¹é…ä¸Š
                if (easyExcelAnno.value()[0].equalsIgnoreCase(theCell.getStringCellValue())) {
                    if (customMerge.isPk()) {
                        pkIndex = index;
                    }

                    if (customMerge.needMerge()) {
                        needMergeColumnIndex.add(index);
                    }
                }
            }
        }

        // æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œåˆ™å¼‚å¸¸
        if (null == this.pkIndex) {
            throw new IllegalStateException("ä½¿ç”¨@CustomMergeæ³¨è§£å¿…é¡»æŒ‡å®šä¸»é”®");
        }

    }
}

```
å®šä¹‰å¯¹åº”Mapperæ¥å£ OrderMapperï¼ŒProductMapper
```java
@Mapper
public interface OrderMapper {
    @Select("SELECT * FROM `order`")
    @Results({
            @Result(property = "id", column = "id"),
            @Result(property = "orderSn", column = "orderSn"),
            @Result(property = "createTime", column = "createTime"),
            @Result(property = "receiverAddress", column = "receiverAddress"),
    })
    List<Order> getOrder();
}


@Mapper
public interface ProductMapper {
        @Select("SELECT * FROM product")
        @Results({
                @Result(property = "id", column = "id"),
                @Result(property = "productSn", column = "productSn"),
                @Result(property = "name", column = "name"),
                @Result(property = "subTitle", column = "subTitle"),
                @Result(property = "brandName", column = "brandName"),
                @Result(property = "price", column = "price"),
                @Result(property = "count", column = "count"),
        })
        List<Product> getProduct();
}
```
å®šä¹‰å¯¹åº”serviceå±‚ OrderServiceImplï¼ŒProductServiceImpl
```java
@Service
public class OrderServiceImpl {
    @Autowired
    OrderMapper mapper;

    public List<Order> getOrder(){
        return mapper.getOrder();
    }
}


@Service
public class ProductServiceImpl {
    @Autowired
    ProductMapper mapper;

    public List<Product> getProduct(){
        return mapper.getProduct();
    }
}

```
 easyexcelControllerä¸­
```java
@RestController
@RequestMapping("/easyexcel")
public class easyexcelController {

    @Autowired
    OrderServiceImpl orderService;
    @Autowired
    ProductMapper productService;
    @Autowired
    MemberMapper memberService;

    // ç®€å•å¯¼å…¥
    @SneakyThrows
    @RequestMapping(value = "/importMemberList", method = RequestMethod.POST)
    @ResponseBody
    public CommonResult importMemberList(@RequestPart("file") MultipartFile file) {
        List<Member> memberList = EasyExcel.read(file.getInputStream())
                .head(Member.class)
                .sheet()
                .doReadSync();
        return CommonResult.success(memberList);
    }


    // è®¾ç½®excelä¸‹è½½å“åº”å¤´å±æ€§
    private void setExcelRespProp(HttpServletResponse response, String rawFileName) throws UnsupportedEncodingException {
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setCharacterEncoding("utf-8");
        String fileName = URLEncoder.encode(rawFileName, "UTF-8").replaceAll("\\+" ,"%20");
        response.setHeader("Content-disposition", "attachment;filename*=utf-8''" + fileName + ".xlsx");
    }

    // ç®€å•å¯¼å‡º
    @SneakyThrows(IOException.class)
    @RequestMapping(value = "/exportMemberList", method = RequestMethod.GET)
    public void exportMemberList(HttpServletResponse response) {
        setExcelRespProp(response, "ä¼šå‘˜åˆ—è¡¨");
        List<Member> memberList = memberService.getMember();
        EasyExcel.write(response.getOutputStream())
                .head(Member.class)
                .excelType(ExcelTypeEnum.XLSX)
                .sheet("ä¼šå‘˜åˆ—è¡¨")
                .doWrite(memberList);
    }

    // å¤æ‚å¯¼å‡º
    @SneakyThrows
    @RequestMapping(value = "/exportOrderList", method = RequestMethod.GET)
    public void exportOrderList(HttpServletResponse response) {
        List<Order> orderList = getOrderList();
        List<OrderData> orderDataList = convert(orderList);
        setExcelRespProp(response, "è®¢å•åˆ—è¡¨");
        EasyExcel.write(response.getOutputStream())
                .head(OrderData.class)
            	// æ³¨å†Œè‡ªå®šä¹‰åˆå¹¶ç­–ç•¥
                .registerWriteHandler(new CustomMergeStrategy(OrderData.class))
                .excelType(ExcelTypeEnum.XLSX)
                .sheet("è®¢å•åˆ—è¡¨")
                .doWrite(orderDataList);
    }

    // å¹³é“ºåˆ°OrderDataä¸Š
    private List<OrderData> convert(List<Order> orderList) {
        List<OrderData> result = new ArrayList<>();
        for (Order order : orderList) {
            List<Product> productList = order.getProductList();
            Member member = order.getMember();
            for (Product product : productList) {
                OrderData orderData = new OrderData();
                BeanUtil.copyProperties(product,orderData);
                BeanUtil.copyProperties(order,orderData);
                BeanUtil.copyProperties(member,orderData);
                result.add(orderData);
            }
        }
        return result;
    }

    private List<Order> getOrderList() {
        List<Order> orderList = orderService.getOrder();
        List<Product> productList = productService.getProduct();
        List<Member> memberList = memberService.getMember();
        for (int i = 0; i < orderList.size(); i++) {
            Order order = orderList.get(i);
            order.setMember(memberList.get(i));
            order.setProductList(productList);
        }
        return orderList;
    }

}

```
overæå®šğŸ¤
â€‹

> ä»¥ä¸Šå‚è€ƒå€Ÿé‰´
> [https://juejin.cn/post/7051751438715715620](https://juejin.cn/post/7051751438715715620)



## æ€»ç»“
EasyExcelä»¥ä½¿ç”¨ç®€å•ã€èŠ‚çœå†…å­˜ï¼Œæ€§èƒ½é«˜æ•ˆè‘—ç§°ã€‚EasyExcel èƒ½å¤§å¤§å‡å°‘å ç”¨å†…å­˜çš„ä¸»è¦åŸå› æ˜¯åœ¨è§£æ Excel æ—¶æ²¡æœ‰å°†æ–‡ä»¶æ•°æ®ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œ è€Œæ˜¯ä»ç£ç›˜ä¸Šä¸€è¡Œè¡Œè¯»å–æ•°æ®ï¼Œé€ä¸ªè§£æã€‚

ä½†æ˜¯å¯¹äºå¤æ‚ç‚¹çš„å¯¼å‡ºï¼Œéœ€è¦è‡ªå·±å®ç°ã€‚è¿™ç‚¹EasyPoiåšçš„è¾ƒå¥½ï¼Œä½¿ç”¨ç®€å•ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯æ€§èƒ½ä½äºeasyexcel




- å¦‚æœExcelå¯¼å‡ºæ•°æ®é‡ä¸å¤§çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨EasyPoi
- å¦‚æœæ•°æ®é‡å¤§ï¼Œæ¯”è¾ƒåœ¨æ„æ€§èƒ½çš„è¯ï¼Œä½¿ç”¨EasyExcelã€‚



